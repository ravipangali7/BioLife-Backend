{% extends 'site/layouts/base.html' %}
{% load static %}

{% block title %}{{ product.name }} - BioLife{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<div class="bg-gradient-to-r from-gray-50 to-white py-4 border-b border-gray-200/50">
    <div class="container mx-auto px-4">
        <nav class="text-sm text-gray-600 flex items-center space-x-2">
            <a href="{% url 'website:home' %}" class="hover:text-biolife-green font-medium transition-colors">Home</a>
            <i data-feather="chevron-right" class="w-4 h-4 text-gray-400"></i>
            <a href="{% url 'website:product_list' %}" class="hover:text-biolife-green font-medium transition-colors">Products</a>
            <i data-feather="chevron-right" class="w-4 h-4 text-gray-400"></i>
            <span class="text-gray-800 font-semibold">{{ product.name|truncatewords:5 }}</span>
        </nav>
    </div>
</div>

<div class="container mx-auto px-4 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Product Images -->
        <div>
            <div class="card-gradient p-6 mb-6 relative overflow-hidden group rounded-2xl">
                {% if product.image %}
                    <img id="main-image" src="{{ product.image.url }}" alt="{{ product.name }}" class="w-full h-96 md:h-[500px] object-contain rounded-xl transition-all duration-300 cursor-zoom-in shadow-inner" onclick="zoomImage(this)">
                {% else %}
                    <div class="w-full h-96 md:h-[500px] bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center rounded-xl">
                        <i data-feather="image" class="w-24 h-24 text-gray-400"></i>
                    </div>
                {% endif %}
                <!-- Flash Deal Badge -->
                {% if product.get_active_flash_deal %}
                <div class="absolute top-6 right-6 bg-gradient-to-r from-red-600 to-pink-600 text-white px-5 py-2.5 rounded-full text-sm font-bold shadow-2xl animate-pulse z-10 border-2 border-white">
                    ðŸ”¥ FLASH DEAL
                </div>
                {% endif %}
                <!-- Image Navigation Arrows -->
                {% if product_images|length > 0 or product.image %}
                <button id="prev-image" class="absolute left-6 top-1/2 transform -translate-y-1/2 bg-white/90 backdrop-blur-sm hover:bg-white rounded-full p-3 shadow-xl opacity-0 group-hover:opacity-100 transition-all duration-300 z-10 hover:scale-110">
                    <i data-feather="chevron-left" class="w-6 h-6 text-gray-800"></i>
                </button>
                <button id="next-image" class="absolute right-6 top-1/2 transform -translate-y-1/2 bg-white/90 backdrop-blur-sm hover:bg-white rounded-full p-3 shadow-xl opacity-0 group-hover:opacity-100 transition-all duration-300 z-10 hover:scale-110">
                    <i data-feather="chevron-right" class="w-6 h-6 text-gray-800"></i>
                </button>
                {% endif %}
            </div>
            
            <!-- Thumbnail Images -->
            {% if product_images or product.image %}
            <div class="flex space-x-3 overflow-x-auto pb-2 scrollbar-hide">
                {% if product.image %}
                    <img src="{{ product.image.url }}" alt="{{ product.name }}" 
                         data-image-url="{{ product.image.url }}"
                         class="thumbnail-image w-28 h-28 object-cover rounded-xl cursor-pointer border-3 border-biolife-green hover:border-biolife-green-dark transition-all duration-300 flex-shrink-0 shadow-md hover:shadow-lg" 
                         onclick="changeMainImage('{{ product.image.url }}', this)">
                {% endif %}
                {% for image in product_images %}
                    <img src="{{ image.image.url }}" alt="{{ product.name }}" 
                         data-image-url="{{ image.image.url }}"
                         class="thumbnail-image w-28 h-28 object-cover rounded-xl cursor-pointer border-3 border-transparent hover:border-biolife-green transition-all duration-300 flex-shrink-0 shadow-md hover:shadow-lg" 
                         onclick="changeMainImage('{{ image.image.url }}', this)">
                {% endfor %}
            </div>
            {% endif %}
        </div>
        
        <!-- Product Info -->
        <div class="lg:sticky lg:top-20 lg:self-start">
            <h1 class="text-3xl font-bold text-gray-800 mb-4">{{ product.name }}</h1>
            
            <!-- Rating -->
            {% if avg_rating > 0 %}
            <div class="flex items-center mb-4">
                <div class="flex items-center">
                    {% for i in "12345"|make_list %}
                        {% if forloop.counter <= avg_rating|floatformat:0|add:"0" %}
                            <i data-feather="star" class="w-5 h-5 text-yellow-400 fill-current"></i>
                        {% else %}
                            <i data-feather="star" class="w-5 h-5 text-gray-300"></i>
                        {% endif %}
                    {% endfor %}
                </div>
                <span class="ml-2 text-gray-600">({{ avg_rating }}) - {{ reviews|length }} reviews</span>
            </div>
            {% endif %}
            
            <!-- Price -->
            <div class="mb-6">
                <div class="flex items-baseline flex-wrap gap-2">
                    <span id="product-price" class="text-4xl font-bold text-biolife-green">Rs {{ product.get_final_price|floatformat:2 }}</span>
                    <span id="product-original-price" class="text-xl text-gray-500 line-through {% if not product.discount and not product.get_active_flash_deal %}hidden{% endif %}">Rs {{ product.regular_price|floatformat:2 }}</span>
                    {% if product.get_active_flash_deal %}
                    <span class="bg-red-600 text-white px-3 py-1 rounded-full text-sm font-bold animate-pulse">
                        ðŸ”¥ FLASH DEAL
                        {% with deal=product.get_active_flash_deal %}
                            {% if deal.discount_type == 'percentage' %}
                                -{{ deal.discount }}%
                            {% else %}
                                -Rs {{ deal.discount }}
                            {% endif %}
                        {% endwith %}
                    </span>
                    {% elif product.discount %}
                    <span class="bg-biolife-blue text-white px-3 py-1 rounded-full text-sm font-bold">
                        {% if product.discount_type == 'percentage' %}
                            Save {{ product.discount }}%
                        {% else %}
                            Save Rs {{ product.discount }}
                        {% endif %}
                    </span>
                    {% endif %}
                </div>
            </div>
            
            <!-- Short Description -->
            {% if product.short_description %}
            <p class="text-gray-700 mb-6">{{ product.short_description }}</p>
            {% endif %}
            
            <!-- Variants -->
            {% if product.product_varient and product.product_varient.enabled and product.product_varient.variants %}
            <div class="mb-6" id="variant-selection-section">
                <label class="block text-gray-700 font-semibold mb-3">
                    Select Variant <span class="text-red-500">*</span>:
                </label>
                <div id="variant-types-container">
                    {% for variant_type in product.product_varient.variants %}
                    <div class="mb-4">
                        <label class="block text-gray-700 font-medium mb-2">{{ variant_type.name }}:</label>
                        <div class="flex flex-wrap gap-3">
                            {% for value in variant_type.values %}
                                <button type="button" 
                                        class="variant-value-btn px-6 py-3 border-2 rounded-xl font-semibold transition-all duration-300 border-gray-300 hover:border-biolife-green hover:bg-biolife-green-light hover:shadow-md transform hover:scale-105 active:scale-100"
                                        data-variant-type="{{ variant_type.name }}"
                                        data-variant-value="{{ value }}">
                                    {{ value }}
                                </button>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <input type="hidden" id="selected-variant" name="variant" value="">
                <p id="variant-error" class="text-red-600 text-sm mt-2 hidden">Please select all variant options before adding to cart.</p>
            </div>
            {% endif %}
            
            <!-- Stock Status -->
            <div class="mb-6">
                <div id="stock-status">
                    {% if product.stock > 0 %}
                        <span class="text-green-600 font-semibold flex items-center">
                            <i data-feather="check-circle" class="w-5 h-5 mr-2"></i>
                            In Stock (<span id="stock-count">{{ product.stock }}</span> available)
                        </span>
                    {% else %}
                        <span class="text-red-600 font-semibold flex items-center">
                            <i data-feather="x-circle" class="w-5 h-5 mr-2"></i>
                            Out of Stock
                        </span>
                    {% endif %}
                </div>
            </div>
            
            <!-- Add to Cart -->
            <form method="post" action="{% url 'website:add_to_cart' product.id %}" class="mb-4">
                {% csrf_token %}
                <input type="hidden" id="form-variant" name="variant" value="">
                <div class="flex items-center space-x-4 mb-4">
                    <label class="text-gray-700 font-semibold">Quantity:</label>
                    <input type="number" id="quantity-input" name="quantity" value="1" min="1" max="{{ product.stock }}" 
                           class="w-20 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-biolife-green">
                </div>
                <button type="submit" id="add-to-cart-btn"
                        class="w-full bg-gradient-to-r from-biolife-green to-biolife-green-dark text-white py-4 rounded-xl hover:shadow-2xl transition-all duration-300 font-bold text-lg shadow-lg hover:shadow-biolife-green/50 transform hover:scale-[1.02] active:scale-100 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none disabled:from-gray-400 disabled:to-gray-500"
                        {% if product.stock == 0 %}disabled{% endif %}>
                    <i data-feather="shopping-cart" class="w-5 h-5 inline mr-2"></i>
                    Add to Cart
                </button>
                {% if product.product_varient and product.product_varient.enabled %}
                <p class="text-sm text-gray-600 mt-2 text-center">* Variant selection is required</p>
                {% endif %}
            </form>
            
            <!-- Earn from Product Button (for influencers) -->
            {% if can_earn and user_earn_code %}
            <div class="mb-6">
                <button type="button" onclick="openEarnDialog()" class="w-full bg-biolife-blue text-white py-3 rounded-lg hover:bg-blue-600 transition-all duration-200 font-semibold text-lg shadow-md hover:shadow-lg">
                    <i data-feather="dollar-sign" class="w-5 h-5 inline mr-2"></i>
                    Earn from Product
                </button>
            </div>
            {% endif %}
            
            <!-- Wishlist Button -->
            {% if user.is_authenticated %}
            <div class="mb-6">
                {% if is_in_wishlist %}
                <form method="post" action="{% url 'website:remove_from_wishlist' product.id %}">
                    {% csrf_token %}
                    <button type="submit" class="w-full bg-gradient-to-r from-red-50 to-pink-50 text-red-600 border-2 border-red-200 py-4 rounded-xl hover:from-red-100 hover:to-pink-100 hover:border-red-300 transition-all duration-300 font-bold text-lg shadow-md hover:shadow-lg transform hover:scale-[1.02] active:scale-100">
                        <i data-feather="heart" class="w-5 h-5 inline mr-2 fill-current"></i>
                        Remove from Wishlist
                    </button>
                </form>
                {% else %}
                <form method="post" action="{% url 'website:add_to_wishlist' product.id %}">
                    {% csrf_token %}
                    <button type="submit" class="w-full bg-gradient-to-r from-gray-50 to-gray-100 text-gray-700 border-2 border-gray-200 py-4 rounded-xl hover:from-gray-100 hover:to-gray-200 hover:border-gray-300 transition-all duration-300 font-bold text-lg shadow-md hover:shadow-lg transform hover:scale-[1.02] active:scale-100">
                        <i data-feather="heart" class="w-5 h-5 inline mr-2"></i>
                        Add to Wishlist
                    </button>
                </form>
                {% endif %}
            </div>
            {% endif %}
            
            <!-- Affiliate Link Indicator -->
            {% if is_affiliate_link and affiliate_user %}
            <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <p class="text-sm text-blue-800">
                    <i data-feather="info" class="w-4 h-4 inline mr-2"></i>
                    You're viewing this product through an affiliate link from {{ affiliate_user.name }}.
                </p>
            </div>
            {% endif %}
            
            <!-- Product Details -->
            {% if product.long_description %}
            <div class="mt-8">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Description</h3>
                <div class="text-gray-700 prose max-w-none product-description-content">
                    {{ product.long_description|safe }}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Reviews Section -->
    <div class="mt-12">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Customer Reviews</h2>
        
        <!-- User's Existing Review -->
        {% if user_review %}
        <div class="card p-6 mb-6 border-2 border-biolife-green">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800">Your Review</h3>
                <span class="text-sm text-gray-500">{{ user_review.created_at|date:"M d, Y" }}</span>
            </div>
            <div class="flex items-center mb-3">
                <div class="flex">
                    {% for i in "12345"|make_list %}
                        {% if forloop.counter <= user_review.star %}
                            <i data-feather="star" class="w-5 h-5 text-yellow-400 fill-current"></i>
                        {% else %}
                            <i data-feather="star" class="w-5 h-5 text-gray-300"></i>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
            {% if user_review.message %}
                <p class="text-gray-700">{{ user_review.message }}</p>
            {% endif %}
            <p class="text-sm text-gray-600 mt-3">You can update your review below.</p>
        </div>
        {% endif %}
        
        <!-- Review Form (for eligible users) -->
        {% if can_review %}
        <div class="card p-6 mb-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">
                {% if user_review %}Update Your Review{% else %}Write a Review{% endif %}
            </h3>
            <form method="post" action="{% url 'website:submit_review' product.id %}">
                {% csrf_token %}
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">Rating</label>
                    <div class="flex items-center space-x-2" id="rating-stars">
                        {% for i in "12345"|make_list %}
                        <button type="button" class="star-btn text-3xl text-gray-300 hover:text-yellow-400 transition-colors" data-rating="{{ forloop.counter }}">
                            <i data-feather="star" class="w-8 h-8"></i>
                        </button>
                        {% endfor %}
                    </div>
                    <input type="hidden" name="star" id="star-rating" value="{% if user_review %}{{ user_review.star }}{% else %}0{% endif %}" required>
                </div>
                <div class="mb-4">
                    <label for="review-message" class="block text-gray-700 font-semibold mb-2">Your Review</label>
                    <textarea name="message" id="review-message" rows="4" 
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-biolife-green"
                              placeholder="Share your experience with this product...">{% if user_review %}{{ user_review.message }}{% endif %}</textarea>
                </div>
                <button type="submit" class="bg-biolife-green text-white px-6 py-2 rounded-lg hover:bg-biolife-green-dark transition-all duration-200 font-semibold shadow-md hover:shadow-lg">
                    {% if user_review %}Update Review{% else %}Submit Review{% endif %}
                </button>
            </form>
        </div>
        {% elif user.is_authenticated %}
        <div class="card p-6 mb-6 bg-gray-50 border border-gray-200">
            <p class="text-gray-600">
                <i data-feather="info" class="w-5 h-5 inline mr-2"></i>
                You can review this product after you purchase and receive it.
            </p>
        </div>
        {% else %}
        <div class="card p-6 mb-6 bg-gray-50 border border-gray-200">
            <p class="text-gray-600">
                <i data-feather="info" class="w-5 h-5 inline mr-2"></i>
                <a href="{% url 'website:login' %}" class="text-biolife-green hover:underline">Login</a> to review this product.
            </p>
        </div>
        {% endif %}
        
        <!-- Other Reviews -->
        {% if reviews %}
            <h3 class="text-xl font-semibold text-gray-800 mb-4 mt-8">All Reviews</h3>
            <div class="space-y-4">
                {% for review in reviews %}
                    {% if not user_review or review.id != user_review.id %}
                    <div class="card p-6">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center">
                                <div class="flex">
                                    {% for i in "12345"|make_list %}
                                        {% if forloop.counter <= review.star %}
                                            <i data-feather="star" class="w-4 h-4 text-yellow-400 fill-current"></i>
                                        {% else %}
                                            <i data-feather="star" class="w-4 h-4 text-gray-300"></i>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                                <span class="ml-2 font-semibold text-gray-800">{{ review.user.name }}</span>
                            </div>
                            <span class="text-sm text-gray-500">{{ review.created_at|date:"M d, Y" }}</span>
                        </div>
                        {% if review.message %}
                            <p class="text-gray-700">{{ review.message }}</p>
                        {% endif %}
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
        {% elif not can_review %}
            <p class="text-gray-600">No reviews yet. Be the first to review this product!</p>
        {% endif %}
    </div>
    
    <!-- Related Products -->
    {% if related_products %}
    <div class="mt-16">
        <h2 class="text-3xl font-bold text-gray-800 mb-8">Related Products</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
            {% for related in related_products %}
            <div class="card overflow-hidden group">
                <a href="{% url 'website:product_detail' related.id %}">
                    <div class="relative overflow-hidden">
                        {% if related.image %}
                            <img src="{{ related.image.url }}" alt="{{ related.name }}" class="w-full h-64 object-cover product-image">
                        {% else %}
                            <div class="w-full h-64 bg-gray-100 flex items-center justify-center">
                                <i data-feather="image" class="w-16 h-16 text-gray-400"></i>
                            </div>
                        {% endif %}
                        {% if related.discount %}
                            <span class="absolute top-3 right-3 bg-biolife-blue text-white px-2.5 py-1 rounded-full text-xs font-bold shadow-md">
                                {% if related.discount_type == 'percentage' %}
                                    -{{ related.discount }}%
                                {% else %}
                                    -Rs {{ related.discount }}
                                {% endif %}
                            </span>
                        {% endif %}
                        {% if related.brand %}
                        <div class="absolute top-3 left-3 bg-white bg-opacity-90 backdrop-blur-sm px-2 py-1 rounded-md">
                            <span class="text-xs font-semibold text-gray-700">{{ related.brand.name }}</span>
                        </div>
                        {% endif %}
                    </div>
                    <div class="p-4">
                        {% if related.category %}
                        <span class="text-xs font-medium text-biolife-green mb-2 block">{{ related.category.name }}</span>
                        {% endif %}
                        <h3 class="font-semibold text-gray-800 mb-2 line-clamp-2 group-hover:text-biolife-green transition-colors">{{ related.name }}</h3>
                        <div class="flex items-center justify-between mt-3">
                            <div>
                                <span class="text-xl font-bold text-biolife-green">Rs {{ related.get_final_price|floatformat:2 }}</span>
                                {% if related.discount or related.get_active_flash_deal %}
                                    <span class="text-sm text-gray-500 line-through ml-2">Rs {{ related.regular_price|floatformat:2 }}</span>
                                {% endif %}
                            </div>
                        </div>
                        {% if related.stock > 0 %}
                            <span class="text-xs text-green-600 mt-2 block flex items-center">
                                <i data-feather="check-circle" class="w-3 h-3 mr-1"></i>
                                In Stock
                            </span>
                        {% else %}
                            <span class="text-xs text-red-600 mt-2 block flex items-center">
                                <i data-feather="x-circle" class="w-3 h-3 mr-1"></i>
                                Out of Stock
                            </span>
                        {% endif %}
                    </div>
                </a>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<script>
    // Image Zoom Functionality
    function zoomImage(img) {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4 cursor-zoom-out';
        modal.onclick = () => modal.remove();
        
        const zoomedImg = document.createElement('img');
        zoomedImg.src = img.src;
        zoomedImg.className = 'max-w-full max-h-full object-contain';
        zoomedImg.onclick = (e) => e.stopPropagation();
        
        modal.appendChild(zoomedImg);
        document.body.appendChild(modal);
    }
    
    // Product variant data from backend
    const productData = {
        regularPrice: {{ product.regular_price }},
        discount: {{ product.discount|default:0 }},
        discountType: '{{ product.discount_type|default:"" }}',
        baseStock: {{ product.stock }},
        variants: {{ variant_data_json|safe }},
        baseImage: '{% if product.image %}{{ product.image.url }}{% endif %}'
    };
    
    let currentImageIndex = 0;
    const thumbnailImages = document.querySelectorAll('.thumbnail-image');
    const imageUrls = Array.from(thumbnailImages).map(img => img.dataset.imageUrl);
    
    function changeMainImage(url, clickedElement) {
        const mainImage = document.getElementById('main-image');
        if (mainImage) {
            mainImage.style.opacity = '0';
            setTimeout(() => {
                mainImage.src = url;
                mainImage.style.opacity = '1';
            }, 150);
        }
        
        // Update thumbnail borders
        document.querySelectorAll('.thumbnail-image').forEach(img => {
            img.classList.remove('border-biolife-green', 'border-biolife-green-dark');
            img.classList.add('border-transparent');
        });
        
        if (clickedElement) {
            clickedElement.classList.remove('border-transparent');
            clickedElement.classList.add('border-biolife-green');
            currentImageIndex = Array.from(thumbnailImages).indexOf(clickedElement);
        }
    }
    
    // Image navigation
    document.getElementById('next-image')?.addEventListener('click', function() {
        if (imageUrls.length > 0) {
            currentImageIndex = (currentImageIndex + 1) % imageUrls.length;
            const nextImg = thumbnailImages[currentImageIndex];
            if (nextImg) {
                changeMainImage(imageUrls[currentImageIndex], nextImg);
            }
        }
    });
    
    document.getElementById('prev-image')?.addEventListener('click', function() {
        if (imageUrls.length > 0) {
            currentImageIndex = (currentImageIndex - 1 + imageUrls.length) % imageUrls.length;
            const prevImg = thumbnailImages[currentImageIndex];
            if (prevImg) {
                changeMainImage(imageUrls[currentImageIndex], prevImg);
            }
        }
    });
    
    // Variant selection with dynamic updates (new structure)
    let selectedVariantValues = {}; // Store selected values for each variant type
    
    // Initialize: Auto-select is_primary variant if available
    function initializePrimaryVariant() {
        if (productData.variants && productData.variants.enabled && productData.variants.combinations) {
            // Find is_primary combination
            for (const comboKey in productData.variants.combinations) {
                const comboData = productData.variants.combinations[comboKey];
                if (comboData && comboData.is_primary === true) {
                    // Parse combination key (e.g., "Red/XL" -> ["Red", "XL"])
                    const values = comboKey.split('/');
                    if (productData.variants.variants && productData.variants.variants.length === values.length) {
                        // Auto-select the primary variant
                        productData.variants.variants.forEach((variantType, index) => {
                            if (values[index]) {
                                selectedVariantValues[variantType.name] = values[index];
                                // Update button styles
                                const btn = document.querySelector(`[data-variant-type="${variantType.name}"][data-variant-value="${values[index]}"]`);
                                if (btn) {
                                    btn.classList.add('bg-biolife-green', 'text-white', 'border-biolife-green');
                                    btn.classList.remove('border-gray-300');
                                }
                            }
                        });
                        updateVariantSelection();
                    }
                    break;
                }
            }
        }
    }
    
    // Update variant selection and combination
    function updateVariantSelection() {
        if (!productData.variants || !productData.variants.enabled) return;
        
        const variantTypes = productData.variants.variants || [];
        const allSelected = variantTypes.every(vt => selectedVariantValues[vt.name]);
        
        if (allSelected) {
            // Build combination key
            const comboKey = variantTypes.map(vt => selectedVariantValues[vt.name]).join('/');
            
            // Update hidden fields
            document.getElementById('selected-variant').value = comboKey;
            document.getElementById('form-variant').value = comboKey;
            
            // Hide error message
            const errorMsg = document.getElementById('variant-error');
            if (errorMsg) errorMsg.classList.add('hidden');
            
            // Enable add to cart button
            const addToCartBtn = document.getElementById('add-to-cart-btn');
            if (addToCartBtn) {
                addToCartBtn.disabled = false;
                addToCartBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
            
            // Update price and stock based on selected combination
            updateProductInfoForVariant(comboKey);
        } else {
            // Show error if not all variants selected
            const errorMsg = document.getElementById('variant-error');
            if (errorMsg) errorMsg.classList.remove('hidden');
            
            // Disable add to cart button
            const addToCartBtn = document.getElementById('add-to-cart-btn');
            if (addToCartBtn) {
                addToCartBtn.disabled = true;
                addToCartBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }
    }
    
    // Update product info (price, stock) based on selected variant
    function updateProductInfoForVariant(comboKey) {
        if (!productData.variants || !productData.variants.combinations) return;
        
        const comboData = productData.variants.combinations[comboKey];
        if (!comboData) return;
        
        // Update price
        let variantPrice = comboData.price || productData.regularPrice;
        let finalPrice = variantPrice;
        
        // Apply variant-level discount if available
        if (comboData.discount_type === 'flat' && comboData.discount) {
            finalPrice = variantPrice - comboData.discount;
        } else if (comboData.discount_type === 'percentage' && comboData.discount) {
            finalPrice = variantPrice * (1 - comboData.discount / 100);
        } else if (productData.discountType === 'flat') {
            finalPrice = variantPrice - productData.discount;
        } else if (productData.discountType === 'percentage') {
            finalPrice = variantPrice * (1 - productData.discount / 100);
        }
        
        finalPrice = Math.max(0, finalPrice);
        
        const priceElement = document.getElementById('product-price');
        if (priceElement) {
            priceElement.textContent = 'Rs ' + finalPrice.toFixed(2);
        }
        
        // Update original price visibility
        const originalPriceElement = document.getElementById('product-original-price');
        if (originalPriceElement && variantPrice !== productData.regularPrice) {
            originalPriceElement.textContent = 'Rs ' + variantPrice.toFixed(2);
            originalPriceElement.classList.remove('hidden');
        }
        
        // Update stock
        const variantStock = comboData.stock !== undefined ? comboData.stock : productData.baseStock;
        const stockCountElement = document.getElementById('stock-count');
        const stockStatusElement = document.getElementById('stock-status');
        const quantityInput = document.getElementById('quantity-input');
        const addToCartBtn = document.getElementById('add-to-cart-btn');
        
        if (stockCountElement) {
            stockCountElement.textContent = variantStock;
        }
        
        if (stockStatusElement) {
            if (variantStock > 0) {
                stockStatusElement.innerHTML = `
                    <span class="text-green-600 font-semibold flex items-center">
                        <i data-feather="check-circle" class="w-5 h-5 mr-2"></i>
                        In Stock (${variantStock} available)
                    </span>
                `;
            } else {
                stockStatusElement.innerHTML = `
                    <span class="text-red-600 font-semibold flex items-center">
                        <i data-feather="x-circle" class="w-5 h-5 mr-2"></i>
                        Out of Stock
                    </span>
                `;
            }
            if (typeof feather !== 'undefined') {
                feather.replace();
            }
        }
        
        if (quantityInput) {
            quantityInput.max = variantStock;
            if (parseInt(quantityInput.value) > variantStock) {
                quantityInput.value = variantStock;
            }
        }
        
        if (addToCartBtn) {
            addToCartBtn.disabled = variantStock === 0;
            if (variantStock === 0) {
                addToCartBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                addToCartBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }
        
        // Update variant image if available
        if (comboData.image) {
            changeMainImage(comboData.image, null);
        }
    }
    
    // Variant value button click handlers
    document.querySelectorAll('.variant-value-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            if (this.disabled) return;
            
            const variantType = this.dataset.variantType;
            const variantValue = this.dataset.variantValue;
            
            // Update selected value for this variant type
            selectedVariantValues[variantType] = variantValue;
            
            // Update button styles for this variant type only
            document.querySelectorAll(`[data-variant-type="${variantType}"]`).forEach(b => {
                if (!b.disabled) {
                    b.classList.remove('bg-gradient-to-r', 'from-biolife-green', 'to-biolife-green-dark', 'text-white', 'border-biolife-green', 'shadow-md');
                    b.classList.add('border-gray-300');
                }
            });
            this.classList.add('bg-gradient-to-r', 'from-biolife-green', 'to-biolife-green-dark', 'text-white', 'border-biolife-green', 'shadow-md');
            this.classList.remove('border-gray-300');
            
            // Update variant selection
            updateVariantSelection();
        });
    });
    
    // Initialize primary variant on page load
    initializePrimaryVariant();
    
    // Validate variant selection before form submission
    const addToCartForm = document.querySelector('form[action*="add_to_cart"]');
    if (addToCartForm) {
        addToCartForm.addEventListener('submit', function(e) {
            if (productData.variants && productData.variants.enabled) {
                const variantTypes = productData.variants.variants || [];
                const allSelected = variantTypes.every(vt => selectedVariantValues[vt.name]);
                
                if (!allSelected) {
                    e.preventDefault();
                    const errorMsg = document.getElementById('variant-error');
                    if (errorMsg) errorMsg.classList.remove('hidden');
                    return false;
                }
            }
        });
    }
    
    // Star rating selection
    const starButtons = document.querySelectorAll('.star-btn');
    const starRatingInput = document.getElementById('star-rating');
    
    starButtons.forEach((btn, index) => {
        btn.addEventListener('click', function() {
            const rating = parseInt(this.dataset.rating);
            starRatingInput.value = rating;
            
            // Update star display
            starButtons.forEach((b, i) => {
                const starIcon = b.querySelector('i');
                if (i < rating) {
                    starIcon.classList.add('text-yellow-400', 'fill-current');
                    starIcon.classList.remove('text-gray-300');
                } else {
                    starIcon.classList.remove('text-yellow-400', 'fill-current');
                    starIcon.classList.add('text-gray-300');
                }
            });
        });
        
        btn.addEventListener('mouseenter', function() {
            const rating = parseInt(this.dataset.rating);
            starButtons.forEach((b, i) => {
                const starIcon = b.querySelector('i');
                if (i < rating) {
                    starIcon.classList.add('text-yellow-400');
                    starIcon.classList.remove('text-gray-300');
                }
            });
        });
    });
    
    // Initialize star display if user has existing review
    {% if user_review %}
    const initialRating = {{ user_review.star }};
    starButtons.forEach((btn, index) => {
        const starIcon = btn.querySelector('i');
        if (index < initialRating) {
            starIcon.classList.add('text-yellow-400', 'fill-current');
            starIcon.classList.remove('text-gray-300');
        }
    });
    {% endif %}
    
    // Initialize feather icons after page load
    document.addEventListener('DOMContentLoaded', function() {
        if (typeof feather !== 'undefined') {
            feather.replace();
        }
    });
    
    // Earn from Product Dialog
    {% if can_earn and user_earn_code %}
    function openEarnDialog() {
        const dialog = document.getElementById('earn-dialog');
        if (dialog) {
            dialog.classList.remove('hidden');
            if (typeof feather !== 'undefined') {
                feather.replace();
            }
        }
    }
    
    function closeEarnDialog() {
        const dialog = document.getElementById('earn-dialog');
        if (dialog) {
            dialog.classList.add('hidden');
        }
    }
    
    function copyAffiliateLink() {
        const linkInput = document.getElementById('affiliate-link-input');
        if (linkInput) {
            linkInput.select();
            linkInput.setSelectionRange(0, 99999); // For mobile devices
            document.execCommand('copy');
            
            const copyBtn = document.getElementById('copy-link-btn');
            if (copyBtn) {
                const originalText = copyBtn.innerHTML;
                copyBtn.innerHTML = '<i data-feather="check" class="w-4 h-4 inline mr-2"></i>Copied!';
                if (typeof feather !== 'undefined') {
                    feather.replace();
                }
                
                setTimeout(() => {
                    copyBtn.innerHTML = originalText;
                    if (typeof feather !== 'undefined') {
                        feather.replace();
                    }
                }, 2000);
            }
        }
    }
    {% else %}
    // Define empty functions if earn dialog is not available
    function openEarnDialog() {}
    function closeEarnDialog() {}
    function copyAffiliateLink() {}
    {% endif %}
</script>

<!-- Earn from Product Modal Dialog -->
{% if can_earn and user_earn_code %}
<div id="earn-dialog" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6">
            <!-- Header -->
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Earn from Product</h2>
                <button onclick="closeEarnDialog()" class="text-gray-500 hover:text-gray-700 transition-colors">
                    <i data-feather="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <!-- Commission Info -->
            <div class="mb-6 p-4 bg-biolife-green-light rounded-lg border border-biolife-green">
                <p class="text-gray-800 font-semibold mb-2">
                    <i data-feather="dollar-sign" class="w-5 h-5 inline mr-2"></i>
                    Commission Rate
                </p>
                <p class="text-gray-700">
                    You earn <strong>{{ commission_percent }}%</strong> commission on each sale made through your affiliate link.
                </p>
            </div>
            
            <!-- Steps -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">How to Earn:</h3>
                <ol class="space-y-4">
                    <li class="flex items-start">
                        <span class="flex-shrink-0 w-8 h-8 bg-biolife-green text-white rounded-full flex items-center justify-center font-bold mr-3">1</span>
                        <div>
                            <p class="font-semibold text-gray-800">Copy Your Affiliate Link</p>
                            <p class="text-gray-600 text-sm">Copy the link below to share this product.</p>
                        </div>
                    </li>
                    <li class="flex items-start">
                        <span class="flex-shrink-0 w-8 h-8 bg-biolife-green text-white rounded-full flex items-center justify-center font-bold mr-3">2</span>
                        <div>
                            <p class="font-semibold text-gray-800">Share on Social Media</p>
                            <p class="text-gray-600 text-sm">Share the link on Facebook, Instagram, TikTok, YouTube, or any platform where your audience can see it.</p>
                        </div>
                    </li>
                    <li class="flex items-start">
                        <span class="flex-shrink-0 w-8 h-8 bg-biolife-green text-white rounded-full flex items-center justify-center font-bold mr-3">3</span>
                        <div>
                            <p class="font-semibold text-gray-800">Earn Commission</p>
                            <p class="text-gray-600 text-sm">When someone purchases through your link and the order is delivered and paid, you'll earn {{ commission_percent }}% commission automatically added to your balance.</p>
                        </div>
                    </li>
                </ol>
            </div>
            
            <!-- Affiliate Link -->
            <div class="mb-6">
                <label class="block text-gray-700 font-semibold mb-2">Your Affiliate Link:</label>
                <div class="flex gap-2">
                    <input type="text" id="affiliate-link-input" 
                           value="http://127.0.0.1:8000{% url 'website:product_detail_affiliate' product.id user_earn_code %}" 
                           readonly
                           class="flex-1 px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-700 focus:outline-none focus:ring-2 focus:ring-biolife-green">
                    <button onclick="copyAffiliateLink()" id="copy-link-btn" 
                            class="px-6 py-2 bg-biolife-green text-white rounded-lg hover:bg-biolife-green-dark transition-colors font-semibold">
                        <i data-feather="copy" class="w-4 h-4 inline mr-2"></i>
                        Copy
                    </button>
                </div>
            </div>
            
            <!-- Social Media Sharing Instructions -->
            <div class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                <h4 class="font-semibold text-gray-800 mb-3">Share on Social Media:</h4>
                <div class="space-y-2 text-sm text-gray-700">
                    <p><strong>Facebook:</strong> Post the link in your feed, groups, or stories with a description of the product.</p>
                    <p><strong>Instagram:</strong> Add the link in your bio or share it in your stories with a swipe-up link.</p>
                    <p><strong>TikTok:</strong> Include the link in your video description or bio.</p>
                    <p><strong>YouTube:</strong> Add the link in your video description or as a pinned comment.</p>
                </div>
            </div>
            
            <!-- Earnings Calculation Example -->
            <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
                <p class="text-sm text-gray-700">
                    <strong>Example:</strong> If someone purchases this product for Rs {{ product.get_final_price|floatformat:2 }}, 
                    you'll earn approximately Rs <span id="commission-amount">0.00</span> 
                    ({{ commission_percent }}% commission).
                </p>
            </div>
            <script>
                // Calculate commission amount for display
                (function() {
                    try {
                        const productPrice = parseFloat({{ product.get_final_price }}) || 0;
                        const commissionPercent = parseFloat({{ commission_percent|default:0 }}) || 0;
                        if (productPrice > 0 && commissionPercent > 0) {
                            const commissionAmount = (productPrice * commissionPercent / 100).toFixed(2);
                            const commissionElement = document.getElementById('commission-amount');
                            if (commissionElement) {
                                commissionElement.textContent = commissionAmount;
                            }
                        }
                    } catch (e) {
                        console.error('Error calculating commission:', e);
                    }
                })();
            </script>
            
            <!-- Close Button -->
            <div class="mt-6 flex justify-end">
                <button onclick="closeEarnDialog()" 
                        class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors font-semibold">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Custom CSS for Long Description Tables -->
<style>
    /* Light border minimalist table design */
    .product-description-content table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        margin: 2rem 0;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        background-color: #ffffff;
        border: none;
    }
    
    /* Table header - purple-blue background with white text */
    .product-description-content table thead {
        background-color: #6150e7;
    }
    
    .product-description-content table th {
        padding: 16px 20px;
        text-align: left;
        font-weight: 700;
        color: #ffffff;
        font-size: 0.95rem;
        border: none;
        background-color: #6150e7;
    }
    
    /* Table body - alternating row colors, light horizontal borders only */
    .product-description-content table td {
        padding: 16px 20px;
        border-bottom: 1px solid #e5e7eb;
        border-left: none;
        border-right: none;
        border-top: none;
        color: #1f2937;
        font-size: 0.95rem;
        vertical-align: middle;
        line-height: 1.6;
        background-color: #ffffff;
    }
    
    /* Alternating row backgrounds */
    .product-description-content table tbody tr:nth-child(even) td {
        background-color: #f9f9f9;
    }
    
    .product-description-content table tbody tr:nth-child(odd) td {
        background-color: #ffffff;
    }
    
    /* Remove border from last row */
    .product-description-content table tbody tr:last-child td {
        border-bottom: none;
    }
    
    /* Subtle hover effect */
    .product-description-content table tbody tr:hover td {
        background-color: #f5f5f5;
    }
    
    /* Responsive design */
    @media (max-width: 768px) {
        .product-description-content table {
            border-radius: 6px;
            margin: 1.5rem 0;
            font-size: 0.875rem;
        }
        
        .product-description-content table th {
            padding: 12px 16px;
            font-size: 0.875rem;
        }
        
        .product-description-content table td {
            padding: 12px 16px;
            font-size: 0.875rem;
        }
    }
    
    /* Ensure tables don't overflow container */
    .product-description-content {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    .product-description-content table {
        min-width: 100%;
    }
</style>
{% endblock %}
