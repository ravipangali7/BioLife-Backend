{% extends 'site/layouts/base.html' %}
{% load static %}

{% block title %}{{ product.name }} - BioLife{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Product Images -->
        <div>
            <div class="bg-white rounded-xl shadow-lg p-4 mb-4 relative overflow-hidden group">
                {% if product.image %}
                    <img id="main-image" src="{{ product.image.url }}" alt="{{ product.name }}" class="w-full h-96 object-contain rounded-lg transition-all duration-300">
                {% else %}
                    <div class="w-full h-96 bg-gray-100 flex items-center justify-center rounded-lg">
                        <i data-feather="image" class="w-24 h-24 text-gray-400"></i>
                    </div>
                {% endif %}
                <!-- Image Navigation Arrows -->
                {% if product_images|length > 0 or product.image %}
                <button id="prev-image" class="absolute left-4 top-1/2 transform -translate-y-1/2 bg-white bg-opacity-80 hover:bg-opacity-100 rounded-full p-2 shadow-md opacity-0 group-hover:opacity-100 transition-opacity">
                    <i data-feather="chevron-left" class="w-6 h-6"></i>
                </button>
                <button id="next-image" class="absolute right-4 top-1/2 transform -translate-y-1/2 bg-white bg-opacity-80 hover:bg-opacity-100 rounded-full p-2 shadow-md opacity-0 group-hover:opacity-100 transition-opacity">
                    <i data-feather="chevron-right" class="w-6 h-6"></i>
                </button>
                {% endif %}
            </div>
            
            <!-- Thumbnail Images -->
            {% if product_images or product.image %}
            <div class="flex space-x-3 overflow-x-auto pb-2 scrollbar-hide">
                {% if product.image %}
                    <img src="{{ product.image.url }}" alt="{{ product.name }}" 
                         data-image-url="{{ product.image.url }}"
                         class="thumbnail-image w-24 h-24 object-cover rounded-lg cursor-pointer border-2 border-biolife-green hover:border-biolife-green-dark transition-all duration-200 flex-shrink-0" 
                         onclick="changeMainImage('{{ product.image.url }}', this)">
                {% endif %}
                {% for image in product_images %}
                    <img src="{{ image.image.url }}" alt="{{ product.name }}" 
                         data-image-url="{{ image.image.url }}"
                         class="thumbnail-image w-24 h-24 object-cover rounded-lg cursor-pointer border-2 border-transparent hover:border-biolife-green transition-all duration-200 flex-shrink-0" 
                         onclick="changeMainImage('{{ image.image.url }}', this)">
                {% endfor %}
            </div>
            {% endif %}
        </div>
        
        <!-- Product Info -->
        <div>
            <h1 class="text-3xl font-bold text-gray-800 mb-4">{{ product.name }}</h1>
            
            <!-- Rating -->
            {% if avg_rating > 0 %}
            <div class="flex items-center mb-4">
                <div class="flex items-center">
                    {% for i in "12345"|make_list %}
                        {% if forloop.counter <= avg_rating|floatformat:0|add:"0" %}
                            <i data-feather="star" class="w-5 h-5 text-yellow-400 fill-current"></i>
                        {% else %}
                            <i data-feather="star" class="w-5 h-5 text-gray-300"></i>
                        {% endif %}
                    {% endfor %}
                </div>
                <span class="ml-2 text-gray-600">({{ avg_rating }}) - {{ reviews|length }} reviews</span>
            </div>
            {% endif %}
            
            <!-- Price -->
            <div class="mb-6">
                <div class="flex items-baseline flex-wrap gap-2">
                    <span id="product-price" class="text-4xl font-bold text-biolife-green">Rs {{ product.get_final_price|floatformat:2 }}</span>
                    <span id="product-original-price" class="text-xl text-gray-500 line-through {% if not product.discount %}hidden{% endif %}">Rs {{ product.regular_price|floatformat:2 }}</span>
                    {% if product.discount %}
                    <span class="bg-biolife-blue text-white px-3 py-1 rounded-full text-sm font-bold">
                        {% if product.discount_type == 'percentage' %}
                            Save {{ product.discount }}%
                        {% else %}
                            Save Rs {{ product.discount }}
                        {% endif %}
                    </span>
                    {% endif %}
                </div>
            </div>
            
            <!-- Short Description -->
            {% if product.short_description %}
            <p class="text-gray-700 mb-6">{{ product.short_description }}</p>
            {% endif %}
            
            <!-- Variants -->
            {% if product.product_varient and product.product_varient.variant_name %}
            <div class="mb-6">
                <label class="block text-gray-700 font-semibold mb-3">
                    {{ product.product_varient.variant_name }}:
                </label>
                <div class="flex flex-wrap gap-3">
                    {% for value in product.product_varient.variant_values %}
                        <button type="button" 
                                class="variant-btn px-5 py-2.5 border-2 rounded-lg font-medium transition-all duration-200 border-gray-300 hover:border-biolife-green hover:bg-biolife-green-light"
                                data-variant="{{ value }}">
                            {{ value }}
                        </button>
                    {% endfor %}
                </div>
                <input type="hidden" id="selected-variant" name="variant" value="">
            </div>
            {% endif %}
            
            <!-- Stock Status -->
            <div class="mb-6">
                <div id="stock-status">
                    {% if product.stock > 0 %}
                        <span class="text-green-600 font-semibold flex items-center">
                            <i data-feather="check-circle" class="w-5 h-5 mr-2"></i>
                            In Stock (<span id="stock-count">{{ product.stock }}</span> available)
                        </span>
                    {% else %}
                        <span class="text-red-600 font-semibold flex items-center">
                            <i data-feather="x-circle" class="w-5 h-5 mr-2"></i>
                            Out of Stock
                        </span>
                    {% endif %}
                </div>
            </div>
            
            <!-- Add to Cart -->
            <form method="post" action="{% url 'website:add_to_cart' product.id %}" class="mb-4">
                {% csrf_token %}
                <input type="hidden" id="form-variant" name="variant" value="">
                <div class="flex items-center space-x-4 mb-4">
                    <label class="text-gray-700 font-semibold">Quantity:</label>
                    <input type="number" id="quantity-input" name="quantity" value="1" min="1" max="{{ product.stock }}" 
                           class="w-20 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-biolife-green">
                </div>
                <button type="submit" id="add-to-cart-btn"
                        class="w-full bg-biolife-green text-white py-3 rounded-lg hover:bg-biolife-green-dark transition-all duration-200 font-semibold text-lg shadow-md hover:shadow-lg transform hover:scale-[1.02] active:scale-100 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
                        {% if product.stock == 0 %}disabled{% endif %}>
                    <i data-feather="shopping-cart" class="w-5 h-5 inline mr-2"></i>
                    Add to Cart
                </button>
            </form>
            
            <!-- Wishlist Button -->
            {% if user.is_authenticated %}
            <div class="mb-6">
                {% if user.wishlist_items.filter(product=product).exists %}
                <form method="post" action="{% url 'website:remove_from_wishlist' product.id %}">
                    {% csrf_token %}
                    <button type="submit" class="w-full bg-red-50 text-red-600 border-2 border-red-200 py-3 rounded-lg hover:bg-red-100 transition-all duration-200 font-semibold text-lg">
                        <i data-feather="heart" class="w-5 h-5 inline mr-2 fill-current"></i>
                        Remove from Wishlist
                    </button>
                </form>
                {% else %}
                <form method="post" action="{% url 'website:add_to_wishlist' product.id %}">
                    {% csrf_token %}
                    <button type="submit" class="w-full bg-gray-50 text-gray-700 border-2 border-gray-200 py-3 rounded-lg hover:bg-gray-100 transition-all duration-200 font-semibold text-lg">
                        <i data-feather="heart" class="w-5 h-5 inline mr-2"></i>
                        Add to Wishlist
                    </button>
                </form>
                {% endif %}
            </div>
            {% endif %}
            
            <!-- Product Details -->
            {% if product.long_description %}
            <div class="mt-8">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Description</h3>
                <div class="text-gray-700 prose max-w-none">
                    {{ product.long_description|linebreaks }}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Reviews Section -->
    <div class="mt-12">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Customer Reviews</h2>
        
        <!-- User's Existing Review -->
        {% if user_review %}
        <div class="card p-6 mb-6 border-2 border-biolife-green">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800">Your Review</h3>
                <span class="text-sm text-gray-500">{{ user_review.created_at|date:"M d, Y" }}</span>
            </div>
            <div class="flex items-center mb-3">
                <div class="flex">
                    {% for i in "12345"|make_list %}
                        {% if forloop.counter <= user_review.star %}
                            <i data-feather="star" class="w-5 h-5 text-yellow-400 fill-current"></i>
                        {% else %}
                            <i data-feather="star" class="w-5 h-5 text-gray-300"></i>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
            {% if user_review.message %}
                <p class="text-gray-700">{{ user_review.message }}</p>
            {% endif %}
            <p class="text-sm text-gray-600 mt-3">You can update your review below.</p>
        </div>
        {% endif %}
        
        <!-- Review Form (for eligible users) -->
        {% if can_review %}
        <div class="card p-6 mb-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">
                {% if user_review %}Update Your Review{% else %}Write a Review{% endif %}
            </h3>
            <form method="post" action="{% url 'website:submit_review' product.id %}">
                {% csrf_token %}
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">Rating</label>
                    <div class="flex items-center space-x-2" id="rating-stars">
                        {% for i in "12345"|make_list %}
                        <button type="button" class="star-btn text-3xl text-gray-300 hover:text-yellow-400 transition-colors" data-rating="{{ forloop.counter }}">
                            <i data-feather="star" class="w-8 h-8"></i>
                        </button>
                        {% endfor %}
                    </div>
                    <input type="hidden" name="star" id="star-rating" value="{% if user_review %}{{ user_review.star }}{% else %}0{% endif %}" required>
                </div>
                <div class="mb-4">
                    <label for="review-message" class="block text-gray-700 font-semibold mb-2">Your Review</label>
                    <textarea name="message" id="review-message" rows="4" 
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-biolife-green"
                              placeholder="Share your experience with this product...">{% if user_review %}{{ user_review.message }}{% endif %}</textarea>
                </div>
                <button type="submit" class="bg-biolife-green text-white px-6 py-2 rounded-lg hover:bg-biolife-green-dark transition-all duration-200 font-semibold shadow-md hover:shadow-lg">
                    {% if user_review %}Update Review{% else %}Submit Review{% endif %}
                </button>
            </form>
        </div>
        {% elif user.is_authenticated %}
        <div class="card p-6 mb-6 bg-gray-50 border border-gray-200">
            <p class="text-gray-600">
                <i data-feather="info" class="w-5 h-5 inline mr-2"></i>
                You can review this product after you purchase and receive it.
            </p>
        </div>
        {% else %}
        <div class="card p-6 mb-6 bg-gray-50 border border-gray-200">
            <p class="text-gray-600">
                <i data-feather="info" class="w-5 h-5 inline mr-2"></i>
                <a href="{% url 'website:login' %}" class="text-biolife-green hover:underline">Login</a> to review this product.
            </p>
        </div>
        {% endif %}
        
        <!-- Other Reviews -->
        {% if reviews %}
            <h3 class="text-xl font-semibold text-gray-800 mb-4 mt-8">All Reviews</h3>
            <div class="space-y-4">
                {% for review in reviews %}
                    {% if not user_review or review.id != user_review.id %}
                    <div class="card p-6">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center">
                                <div class="flex">
                                    {% for i in "12345"|make_list %}
                                        {% if forloop.counter <= review.star %}
                                            <i data-feather="star" class="w-4 h-4 text-yellow-400 fill-current"></i>
                                        {% else %}
                                            <i data-feather="star" class="w-4 h-4 text-gray-300"></i>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                                <span class="ml-2 font-semibold text-gray-800">{{ review.user.name }}</span>
                            </div>
                            <span class="text-sm text-gray-500">{{ review.created_at|date:"M d, Y" }}</span>
                        </div>
                        {% if review.message %}
                            <p class="text-gray-700">{{ review.message }}</p>
                        {% endif %}
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
        {% elif not can_review %}
            <p class="text-gray-600">No reviews yet. Be the first to review this product!</p>
        {% endif %}
    </div>
    
    <!-- Related Products -->
    {% if related_products %}
    <div class="mt-16">
        <h2 class="text-3xl font-bold text-gray-800 mb-8">Related Products</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
            {% for related in related_products %}
            <div class="card overflow-hidden group">
                <a href="{% url 'website:product_detail' related.id %}">
                    <div class="relative overflow-hidden">
                        {% if related.image %}
                            <img src="{{ related.image.url }}" alt="{{ related.name }}" class="w-full h-64 object-cover product-image">
                        {% else %}
                            <div class="w-full h-64 bg-gray-100 flex items-center justify-center">
                                <i data-feather="image" class="w-16 h-16 text-gray-400"></i>
                            </div>
                        {% endif %}
                        {% if related.discount %}
                            <span class="absolute top-3 right-3 bg-biolife-blue text-white px-2.5 py-1 rounded-full text-xs font-bold shadow-md">
                                {% if related.discount_type == 'percentage' %}
                                    -{{ related.discount }}%
                                {% else %}
                                    -Rs {{ related.discount }}
                                {% endif %}
                            </span>
                        {% endif %}
                        {% if related.brand %}
                        <div class="absolute top-3 left-3 bg-white bg-opacity-90 backdrop-blur-sm px-2 py-1 rounded-md">
                            <span class="text-xs font-semibold text-gray-700">{{ related.brand.name }}</span>
                        </div>
                        {% endif %}
                    </div>
                    <div class="p-4">
                        {% if related.category %}
                        <span class="text-xs font-medium text-biolife-green mb-2 block">{{ related.category.name }}</span>
                        {% endif %}
                        <h3 class="font-semibold text-gray-800 mb-2 line-clamp-2 group-hover:text-biolife-green transition-colors">{{ related.name }}</h3>
                        <div class="flex items-center justify-between mt-3">
                            <div>
                                <span class="text-xl font-bold text-biolife-green">Rs {{ related.get_final_price|floatformat:2 }}</span>
                                {% if related.discount %}
                                    <span class="text-sm text-gray-500 line-through ml-2">Rs {{ related.regular_price|floatformat:2 }}</span>
                                {% endif %}
                            </div>
                        </div>
                        {% if related.stock > 0 %}
                            <span class="text-xs text-green-600 mt-2 block flex items-center">
                                <i data-feather="check-circle" class="w-3 h-3 mr-1"></i>
                                In Stock
                            </span>
                        {% else %}
                            <span class="text-xs text-red-600 mt-2 block flex items-center">
                                <i data-feather="x-circle" class="w-3 h-3 mr-1"></i>
                                Out of Stock
                            </span>
                        {% endif %}
                    </div>
                </a>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<script>
    // Product variant data from backend
    const productData = {
        regularPrice: {{ product.regular_price }},
        discount: {{ product.discount|default:0 }},
        discountType: '{{ product.discount_type|default:"" }}',
        baseStock: {{ product.stock }},
        variants: {{ variant_data_json|safe }},
        baseImage: '{% if product.image %}{{ product.image.url }}{% endif %}'
    };
    
    let currentImageIndex = 0;
    const thumbnailImages = document.querySelectorAll('.thumbnail-image');
    const imageUrls = Array.from(thumbnailImages).map(img => img.dataset.imageUrl);
    
    function changeMainImage(url, clickedElement) {
        const mainImage = document.getElementById('main-image');
        if (mainImage) {
            mainImage.style.opacity = '0';
            setTimeout(() => {
                mainImage.src = url;
                mainImage.style.opacity = '1';
            }, 150);
        }
        
        // Update thumbnail borders
        document.querySelectorAll('.thumbnail-image').forEach(img => {
            img.classList.remove('border-biolife-green', 'border-biolife-green-dark');
            img.classList.add('border-transparent');
        });
        
        if (clickedElement) {
            clickedElement.classList.remove('border-transparent');
            clickedElement.classList.add('border-biolife-green');
            currentImageIndex = Array.from(thumbnailImages).indexOf(clickedElement);
        }
    }
    
    // Image navigation
    document.getElementById('next-image')?.addEventListener('click', function() {
        if (imageUrls.length > 0) {
            currentImageIndex = (currentImageIndex + 1) % imageUrls.length;
            const nextImg = thumbnailImages[currentImageIndex];
            if (nextImg) {
                changeMainImage(imageUrls[currentImageIndex], nextImg);
            }
        }
    });
    
    document.getElementById('prev-image')?.addEventListener('click', function() {
        if (imageUrls.length > 0) {
            currentImageIndex = (currentImageIndex - 1 + imageUrls.length) % imageUrls.length;
            const prevImg = thumbnailImages[currentImageIndex];
            if (prevImg) {
                changeMainImage(imageUrls[currentImageIndex], prevImg);
            }
        }
    });
    
    // Variant selection with dynamic updates
    document.querySelectorAll('.variant-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            if (this.disabled) return;
            
            const selectedVariant = this.dataset.variant;
            
            // Update button styles
            document.querySelectorAll('.variant-btn').forEach(b => {
                if (!b.disabled) {
                    b.classList.remove('bg-biolife-green', 'text-white', 'border-biolife-green');
                    b.classList.add('border-gray-300');
                }
            });
            this.classList.add('bg-biolife-green', 'text-white', 'border-biolife-green');
            this.classList.remove('border-gray-300');
            
            // Update hidden fields
            document.getElementById('selected-variant').value = selectedVariant;
            document.getElementById('form-variant').value = selectedVariant;
            
            // Get variant combination data
            if (productData.variants && productData.variants.combinations) {
                const comboData = productData.variants.combinations[selectedVariant];
                
                if (comboData) {
                    // Update price
                    let variantPrice = comboData.price || productData.regularPrice;
                    let finalPrice = variantPrice;
                    
                    if (productData.discountType === 'flat') {
                        finalPrice = variantPrice - productData.discount;
                    } else if (productData.discountType === 'percentage') {
                        finalPrice = variantPrice * (1 - productData.discount / 100);
                    }
                    
                    finalPrice = Math.max(0, finalPrice);
                    
                    const priceElement = document.getElementById('product-price');
                    if (priceElement) {
                        priceElement.textContent = 'Rs ' + finalPrice.toFixed(2);
                    }
                    
                    // Update original price visibility
                    const originalPriceElement = document.getElementById('product-original-price');
                    if (originalPriceElement && variantPrice !== productData.regularPrice) {
                        originalPriceElement.textContent = 'Rs ' + variantPrice.toFixed(2);
                        originalPriceElement.classList.remove('hidden');
                    }
                    
                    // Update stock
                    const variantStock = comboData.stock !== undefined ? comboData.stock : productData.baseStock;
                    const stockCountElement = document.getElementById('stock-count');
                    const stockStatusElement = document.getElementById('stock-status');
                    const quantityInput = document.getElementById('quantity-input');
                    const addToCartBtn = document.getElementById('add-to-cart-btn');
                    
                    if (stockCountElement) {
                        stockCountElement.textContent = variantStock;
                    }
                    
                    if (stockStatusElement) {
                        if (variantStock > 0) {
                            stockStatusElement.innerHTML = `
                                <span class="text-green-600 font-semibold flex items-center">
                                    <i data-feather="check-circle" class="w-5 h-5 mr-2"></i>
                                    In Stock (${variantStock} available)
                                </span>
                            `;
                        } else {
                            stockStatusElement.innerHTML = `
                                <span class="text-red-600 font-semibold flex items-center">
                                    <i data-feather="x-circle" class="w-5 h-5 mr-2"></i>
                                    Out of Stock
                                </span>
                            `;
                        }
                        if (typeof feather !== 'undefined') {
                            feather.replace();
                        }
                    }
                    
                    if (quantityInput) {
                        quantityInput.max = variantStock;
                        if (parseInt(quantityInput.value) > variantStock) {
                            quantityInput.value = variantStock;
                        }
                    }
                    
                    if (addToCartBtn) {
                        addToCartBtn.disabled = variantStock === 0;
                        if (variantStock === 0) {
                            addToCartBtn.classList.add('opacity-50', 'cursor-not-allowed');
                        } else {
                            addToCartBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                        }
                    }
                    
                    // Update variant button states based on stock
                    document.querySelectorAll('.variant-btn').forEach(btn => {
                        const btnVariant = btn.dataset.variant;
                        const btnComboData = productData.variants.combinations && productData.variants.combinations[btnVariant];
                        const btnStock = btnComboData && btnComboData.stock !== undefined ? btnComboData.stock : productData.baseStock;
                        
                        if (btnStock === 0 && btn !== this) {
                            btn.disabled = true;
                            btn.classList.add('opacity-60', 'cursor-not-allowed', 'bg-gray-100', 'text-gray-400');
                            btn.classList.remove('hover:border-biolife-green', 'hover:bg-biolife-green-light');
                        } else if (btn !== this) {
                            btn.disabled = false;
                            btn.classList.remove('opacity-60', 'cursor-not-allowed', 'bg-gray-100', 'text-gray-400');
                            btn.classList.add('hover:border-biolife-green', 'hover:bg-biolife-green-light');
                        }
                    });
                    
                    // Update main image if variant has specific image
                    if (comboData.image) {
                        changeMainImage(comboData.image, null);
                    }
                }
            }
        });
    });
    
    // Star rating selection
    const starButtons = document.querySelectorAll('.star-btn');
    const starRatingInput = document.getElementById('star-rating');
    
    starButtons.forEach((btn, index) => {
        btn.addEventListener('click', function() {
            const rating = parseInt(this.dataset.rating);
            starRatingInput.value = rating;
            
            // Update star display
            starButtons.forEach((b, i) => {
                const starIcon = b.querySelector('i');
                if (i < rating) {
                    starIcon.classList.add('text-yellow-400', 'fill-current');
                    starIcon.classList.remove('text-gray-300');
                } else {
                    starIcon.classList.remove('text-yellow-400', 'fill-current');
                    starIcon.classList.add('text-gray-300');
                }
            });
        });
        
        btn.addEventListener('mouseenter', function() {
            const rating = parseInt(this.dataset.rating);
            starButtons.forEach((b, i) => {
                const starIcon = b.querySelector('i');
                if (i < rating) {
                    starIcon.classList.add('text-yellow-400');
                    starIcon.classList.remove('text-gray-300');
                }
            });
        });
    });
    
    // Initialize star display if user has existing review
    {% if user_review %}
    const initialRating = {{ user_review.star }};
    starButtons.forEach((btn, index) => {
        const starIcon = btn.querySelector('i');
        if (index < initialRating) {
            starIcon.classList.add('text-yellow-400', 'fill-current');
            starIcon.classList.remove('text-gray-300');
        }
    });
    {% endif %}
    
    // Initialize feather icons after page load
    document.addEventListener('DOMContentLoaded', function() {
        if (typeof feather !== 'undefined') {
            feather.replace();
        }
    });
</script>
{% endblock %}
