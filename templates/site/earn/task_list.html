{% extends 'site/layouts/base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}Earn Rewards - BioLife{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="flex flex-col md:flex-row justify-between items-center mb-8">
        <h1 class="text-3xl font-bold text-gray-800">Earn Rewards</h1>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
        <!-- Sidebar -->
        {% include 'site/layouts/account_sidebar.html' %}

        <!-- Main Content -->
        <div class="lg:col-span-3">
            {% if not has_access %}
                {% if is_influencer %}
                <!-- Influencer without approved KYC -->
                <div class="{% if kyc_status == 'rejected' %}bg-red-50 border-l-4 border-red-400{% elif kyc_status == 'pending' %}bg-yellow-50 border-l-4 border-yellow-400{% else %}bg-yellow-50 border-l-4 border-yellow-400{% endif %} p-4 mb-8">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            {% if kyc_status == 'rejected' %}
                            <i data-feather="x-circle" class="h-5 w-5 text-red-400"></i>
                            {% elif kyc_status == 'pending' %}
                            <i data-feather="clock" class="h-5 w-5 text-yellow-400"></i>
                            {% else %}
                            <i data-feather="alert-triangle" class="h-5 w-5 text-yellow-400"></i>
                            {% endif %}
                        </div>
                        <div class="ml-3">
                            <p class="text-sm {% if kyc_status == 'rejected' %}text-red-700{% else %}text-yellow-700{% endif %} font-semibold mb-1">
                                {% if kyc_status == 'rejected' %}
                                KYC Verification Rejected
                                {% elif kyc_status == 'pending' %}
                                KYC Verification Pending
                                {% else %}
                                KYC Verification Required
                                {% endif %}
                            </p>
                            <p class="text-sm {% if kyc_status == 'rejected' %}text-red-700{% else %}text-yellow-700{% endif %}">
                                {% if kyc_status == 'rejected' %}
                                Your KYC verification was rejected. Please update your documents and resubmit in your <a
                                    href="{% url 'website:account_kyc' %}" class="underline font-bold">KYC page</a>.
                                {% elif kyc_status == 'pending' %}
                                Your KYC documents are under review. Please wait for admin approval to access Earn Rewards.
                                {% else %}
                                You need to complete KYC verification in your <a
                                    href="{% url 'website:account_kyc' %}" class="underline font-bold">KYC page</a> to
                                access Earn Rewards and generate your Earn Code.
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
                {% else %}
                <!-- Customer -->
                <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-8">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i data-feather="info" class="h-5 w-5 text-blue-400"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-blue-700 font-semibold mb-1">
                                Influencer Feature
                            </p>
                            <p class="text-sm text-blue-700">
                                Earn Rewards is only available for verified influencers. If you're an influencer, please register with an influencer account and complete KYC verification.
                            </p>
                        </div>
                    </div>
                </div>
                {% endif %}
            {% endif %}

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                {% for task in tasks %}
                {% with submission=submission_map|get_item:task.id %}
                <div class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow">
                    <div class="p-6">
                        <div class="flex justify-between items-start mb-4">
                            <span
                                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                {{ task.get_social_media_display }}
                            </span>
                            <span class="text-lg font-bold text-biolife-green">Rs {{ task.amount }}</span>
                        </div>

                        <h3 class="text-xl font-bold text-gray-800 mb-2">{{ task.title }}</h3>
                        <p class="text-gray-600 mb-4">{{ task.target }}</p>

                        {% if submission %}
                        {% if submission.status == 'approved' %}
                        <div class="w-full bg-green-100 text-green-800 py-2 rounded-lg text-center font-semibold">
                            Completed <i data-feather="check" class="inline w-4 h-4 ml-1"></i>
                        </div>
                        {% elif submission.status == 'rejected' %}
                        <a href="{% url 'website:task_detail' task.id %}"
                            class="block w-full bg-red-100 text-red-800 py-2 rounded-lg text-center font-semibold hover:bg-red-200 transition-colors">
                            Rejected (Retry)
                        </a>
                        {% else %}
                        <a href="{% url 'website:task_detail' task.id %}"
                            class="block w-full bg-yellow-100 text-yellow-800 py-2 rounded-lg text-center font-semibold hover:bg-yellow-200 transition-colors">
                            Pending Approval
                        </a>
                        {% endif %}
                        {% else %}
                        {% if has_access %}
                        <a href="{% url 'website:task_detail' task.id %}"
                            class="block w-full bg-gray-800 text-white py-2 rounded-lg text-center font-semibold hover:bg-gray-700 transition-colors">
                            Start Task
                        </a>
                        {% else %}
                        <div class="block w-full bg-gray-300 text-gray-600 py-2 rounded-lg text-center font-semibold cursor-not-allowed">
                            Start Task (Locked)
                        </div>
                        {% endif %}
                        {% endif %}
                    </div>
                </div>
                {% endwith %}
                {% empty %}
                <div class="col-span-full text-center py-12">
                    <div class="text-gray-400 mb-4">
                        <i data-feather="inbox" class="w-16 h-16 mx-auto"></i>
                    </div>
                    <h3 class="text-xl font-medium text-gray-900">No tasks available right now</h3>
                    <p class="text-gray-500">Check back later for new opportunities to earn.</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}